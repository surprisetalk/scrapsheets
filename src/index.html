<!doctype html>
<html lang="en">
  <head>
    <title>scrapsheets</title>
    <meta charset="UTF-8" />
    <meta name="author" content="Taylor Troesh" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="color-scheme" content="dark light" />
    <meta
      name="theme-color"
      content="#ffffff"
      media="(prefers-color-scheme: light)" />
    <meta
      name="theme-color"
      content="#151515"
      media="(prefers-color-scheme: dark)" />
    <script src="/index.js"></script>
  </head>
  <body>
    <div id="elm"></div>
    <script type="module">
      import * as AM from "https://esm.sh/@automerge/react@2.0.0/slim?bundle-deps";
      await AM.initializeWasm(
        fetch("https://esm.sh/@automerge/automerge/dist/automerge.wasm"),
      );
      const repo = new AM.Repo({
        storage: new AM.IndexedDBStorageAdapter(),
        // network: [new AM.BrowserWebSocketClientAdapter("wss://sync.automerge.org")],
      });
      const docUrl = window.location.hash.slice(1);
      const doc =
        docUrl && AM.isValidAutomergeUrl(docUrl)
          ? ((await repo.find(docUrl).catch(() => {})) ?? repo.create({}))
          : repo.create({
              cols: [{ key: "A", label: "A", type: "text" }],
              rows: [{ A: "hello" }, { A: "world" }],
            });
      await doc.isReady();
      window.location.hash = doc.url || docUrl;
      const app = Elm.Main.init({
        node: document.getElementById("elm"),
        flags: {
          host: window.location.host,
          docUrl,
          doc: await doc.doc(),
          library: {}, // TODO: Root doc.
        },
      });

      console.log(await doc.doc());
      doc.on("change", data => {
        data.patches = data.patches.map(p => ({ ...p, values: [p.value] }));
        app.ports.docChanged.send({ bookId: "TODO", sheetId: "TODO", data });
      });
      app.ports.changeDoc.subscribe(
        // TODO: Use custom patches for now.
        ({ bookId, sheetId, data: patches }) => {
          for (const patch of patches) {
            // TODO: Check bookId and sheetId.
            doc.change(d => {
              console.log(patch);
              if (!d.cols) d.cols = [];
              if (!d.rows) d.rows = [];
              switch (patch.action) {
                case "cell-put":
                  const [_, y, x] = patch.path;
                  if (!d.rows[y]) d.rows[y] = {};
                  d.rows[y][x] = patch.values[0];
                  break;
                case "row-insert":
                  d.rows.insertAt(1 + patch.path[1], patch.values[0]);
                  break;
                case "col-insert":
                  // TODO: Intelligently pick a column based on existing columns and rows.
                  d.cols.push({
                    key: Math.random().toString().slice(2),
                    label: Math.random().toString().slice(2),
                    type: "same",
                  });
                  break;
                default:
                  throw new Error("TODO");
              }
            });
          }
        },
      );
    </script>
  </body>
</html>
