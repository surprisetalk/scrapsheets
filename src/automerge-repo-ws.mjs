/**
 * Bundled by jsDelivr using Rollup v2.79.2 and Terser v5.39.0.
 * Original file: /npm/@automerge/automerge-repo-network-websocket@2.5.1/dist/index.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{cbor as e,NetworkAdapter as t}from"@automerge/automerge-repo/slim";import s from"https://cdn.jsdelivr.net/npm/isomorphic-ws@5.0.0/+esm";import r from"https://cdn.jsdelivr.net/npm/debug@4.4.3/+esm";const o="1";function i(e,t="Assertion failed"){if(!1===e||null==e){const e=new Error(n(t));throw e.stack=d(e.stack,"assert.ts"),e}}const n=e=>e.split("\n").map((e=>e.trim())).join("\n"),d=(e="",t)=>e.split("\n").filter((e=>!e.includes(t))).join("\n"),a=e=>{const{buffer:t,byteOffset:s,byteLength:r}=e;return t.slice(s,s+r)};class c extends t{socket}class h extends c{url;retryInterval;#e=!1;#t;#s=new Promise((e=>{this.#t=e}));isReady(){return this.#e}whenReady(){return this.#s}#r(){this.#e||(this.#e=!0,this.#t?.())}#o;#i=r("automerge-repo:websocket:browser");remotePeerId;constructor(e,t=5e3){super(),this.url=e,this.retryInterval=t,this.#i=this.#i.extend(e)}connect(e,t){this.socket&&this.peerId?(this.#i("reconnecting"),i(e===this.peerId),this.socket.removeEventListener("open",this.onOpen),this.socket.removeEventListener("close",this.onClose),this.socket.removeEventListener("message",this.onMessage),this.socket.removeEventListener("error",this.onError)):(this.#i("connecting"),this.peerId=e,this.peerMetadata=t??{}),this.#o||(this.#o=setInterval((()=>{this.connect(e,t)}),this.retryInterval)),this.socket=new s(this.url),this.socket.binaryType="arraybuffer",this.socket.addEventListener("open",this.onOpen),this.socket.addEventListener("close",this.onClose),this.socket.addEventListener("message",this.onMessage),this.socket.addEventListener("error",this.onError),setTimeout((()=>this.#r()),1e3),this.join()}onOpen=()=>{this.#i("open"),clearInterval(this.#o),this.#o=void 0,this.join()};onClose=()=>{this.#i("close"),this.remotePeerId&&this.emit("peer-disconnected",{peerId:this.remotePeerId}),this.retryInterval>0&&!this.#o&&setTimeout((()=>(i(this.peerId),this.connect(this.peerId,this.peerMetadata))),this.retryInterval)};onMessage=e=>{this.receiveMessage(e.data)};onError=e=>{if("error"in e&&"ECONNREFUSED"!==e.error.code)throw e.error;this.#i("Connection failed, retrying...")};join(){var e,t;i(this.peerId),i(this.socket),this.socket.readyState===s.OPEN&&this.send((e=this.peerId,t=this.peerMetadata,{type:"join",senderId:e,peerMetadata:t,supportedProtocolVersions:[o]}))}disconnect(){i(this.peerId),i(this.socket);const e=this.socket;e&&(e.removeEventListener("open",this.onOpen),e.removeEventListener("close",this.onClose),e.removeEventListener("message",this.onMessage),e.removeEventListener("error",this.onError),e.close()),clearInterval(this.#o),this.remotePeerId&&this.emit("peer-disconnected",{peerId:this.remotePeerId}),this.socket=void 0}send(t){if("data"in t&&0===t.data?.byteLength)throw new Error("Tried to send a zero-length message");if(i(this.peerId),!this.socket)return void this.#i("Tried to send on a disconnected socket.");if(this.socket.readyState!==s.OPEN)throw new Error(`Websocket not ready (${this.socket.readyState})`);const r=e.encode(t);this.socket.send(a(r))}peerCandidate(e,t){i(this.socket),this.#r(),this.remotePeerId=e,this.emit("peer-candidate",{peerId:e,peerMetadata:t})}receiveMessage(t){let s;try{s=e.decode(new Uint8Array(t))}catch(e){return void this.#i("error decoding message:",e)}if(i(this.socket),0===t.byteLength)throw new Error("received a zero-length message");if((e=>"peer"===e.type)(s)){const{peerMetadata:e}=s;this.#i(`peer: ${s.senderId}`),this.peerCandidate(s.senderId,e)}else(e=>"error"===e.type)(s)?this.#i(`error: ${s.message}`):this.emit("message",s)}}const l=r("WebsocketServer"),{encode:p,decode:v}=e;class m extends t{server;keepAliveInterval;sockets={};#e=!1;#t;#s=new Promise((e=>{this.#t=e}));isReady(){return this.#e}whenReady(){return this.#s}#r(){this.#e||(this.#e=!0,this.#t?.())}constructor(e,t=5e3){super(),this.server=e,this.keepAliveInterval=t}connect(e,t){this.peerId=e,this.peerMetadata=t,this.server.on("close",(()=>{clearInterval(s),this.disconnect()})),this.server.on("connection",(e=>{e.on("close",(()=>{this.#n(e)})),e.on("message",(t=>this.receiveMessage(t,e))),e.isAlive=!0,e.on("pong",(()=>e.isAlive=!0)),this.#r()}));const s=setInterval((()=>{this.server.clients.forEach((e=>{e.isAlive?(e.isAlive=!1,e.ping()):this.#d(e)}))}),this.keepAliveInterval)}disconnect(){this.server.clients.forEach((e=>{this.#d(e),this.#n(e)}))}send(e){if(i("targetId"in e&&void 0!==e.targetId),"data"in e&&0===e.data?.byteLength)throw new Error("Tried to send a zero-length message");i(this.peerId,"No peerId set for the websocket server network adapter.");const t=this.sockets[e.targetId];if(!t)return void l(`Tried to send to disconnected peer: ${e.targetId}`);const s=p(e),r=a(s);t.send(r)}receiveMessage(e,t){let r;try{r=v(e)}catch(e){return l("invalid message received, closing connection"),void t.close()}const{type:n,senderId:d}=r,a=this.peerId;i(a);const c="documentId"in r?"@"+r.documentId:"",{byteLength:h}=e;if(l(`[${d}->${a}${c}] ${n} | ${h} bytes`),(e=>"join"===e.type)(r)){const{peerMetadata:e,supportedProtocolVersions:i}=r,n=this.sockets[d];n&&(n.readyState===s.OPEN&&n.close(),this.emit("peer-disconnected",{peerId:d})),this.emit("peer-candidate",{peerId:d,peerMetadata:e}),this.sockets[d]=t;null===I(i)?(this.send({type:"error",senderId:this.peerId,message:"unsupported protocol version",targetId:d}),this.sockets[d].close(),delete this.sockets[d]):this.send({type:"peer",senderId:this.peerId,peerMetadata:this.peerMetadata,selectedProtocolVersion:o,targetId:d})}else this.emit("message",r)}#d(e){this.#n(e),e.terminate()}#n(e){const t=this.#a(e);t&&(this.emit("peer-disconnected",{peerId:t}),delete this.sockets[t])}#a=e=>Object.keys(this.sockets).find((t=>this.sockets[t]===e))??null}const I=e=>void 0===e||e.includes(o)?o:null;export{h as BrowserWebSocketClientAdapter,m as NodeWSServerAdapter,o as ProtocolV1,h as WebSocketClientAdapter,m as WebSocketServerAdapter};export default null;
//# sourceMappingURL=/sm/784b9556658598aeb95df171f025782e2f2c2822944c7fce1c088b00d28dcfa2.map