<!DOCTYPE HTML>
<html>
<head>
  <meta charset="UTF-8">
  <title>Main</title>
  <script src="elm.js"></script>
</head>

<body>
  <div id="app"></div>
  <script>
    const app = Elm.Main.init({ node: document.getElementById('app') });
    app.ports.applyJsToSheet.subscribe(async ({code,data}) => 
      app.ports.clipboardResultReceived.send(await eval?.(`
        "use strict";
        const sum = xs => xs.reduce((a,b) => a + parseInt(b), 0);
        const mean = xs => sum(xs) / xs.length;
        const chunk = ({ cols: n, cells: xs }) => Array.from({ length: Math.ceil(xs.length/n) }, (v,i) => xs.slice(i*n,i*n+n));
        const sheet = (cols, cells) => ({ cols, cells: cells.map(x => x?.toString() ?? "") });
        const row = xs => sheet(xs.length, xs.map(x => x?.toString() ?? ""));
        const col = xs => sheet(1, xs.map(x => x?.toString() ?? ""));
        const identity = s => s;
        const transpose = s => { const xs = chunk(s); return sheet(Math.floor(s.cells.length/s.cols), xs[0].flatMap((_,i) => xs.map(row => row[i]))) };
        const mcells = f => s => ({ ...s, cells: s.cells.map(f).map(x => x?.toString() ?? "") });
        const rrows = f => s => sheet(1, chunk(s).map(f));
        const rcols = f => s => { const xs = chunk(s); return sheet(Math.floor(s.cells.length/s.cols), xs[0].map((_,i) => xs.map(row => row[i])).map(f)); };
        const wrap = cols => s => ({ ...s, cols });
        (${code})(${JSON.stringify(data)})
      `))
    );
  </script>
</body>
</html>
